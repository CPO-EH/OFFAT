<!doctype html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OWASP OFFAT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>

<body>
    <nav class="navbar navbar-light bg-gradient">
        <div class="container-fluid justify-content-center">
            <a class="navbar-brand fw-bold" href="https://github.com/OWASP/OFFAT">
                <img src="/assets/images/logos/offat-3.png" alt="offat logo" width="40" height="40"
                    class="d-inline-block align-text-center">
                OWASP OFFAT
            </a>
            <button id="theme-toggle" class="btn" onclick="changeTheme()"><i id="theme-toggle-icon"
                    class="bi bi-brightness-high-fill"></i></button>
        </div>
    </nav>
    <div class="container">
        <div id="test-endpoint" class="text-center container fw-bold">

        </div>
        <!-- Requests response table -->
        <div class="container text-left py-2">
            <div class="row align-items-start">
                <div class="col">
                    <div class="text-center fw-bold">Request</div>
                    <div class="card">
                        <div id="request-card" class="card-body"
                            style="height:430px; overflow-y: auto; font-family: 'Courier New', monospace;">
                            {{request}}
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="text-center fw-bold">Response</div>
                    <div class="card">
                        <div id="response-card" class="card-body"
                            style="height:430px; overflow-y: auto; font-family: 'Courier New', monospace;">
                            {{response}}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Details -->
            <div class="row">
                <div class="col align-items-start my-2">
                    <div class="row">
                        <div class="col align-items-start text-left"><strong>Test Name:</strong></div>
                        <div id="test-name" class="col align-items-start text-left"></div>
                    </div>
                    <div class="row">
                        <div class="col align-items-start text-left"><strong>Test Result:</strong></div>
                        <div id="test-result" class="col align-items-start text-left"></div>
                    </div>
                </div>
                <div class=" col align-items-start my-2">
                    <div class="row">
                        <div class="col align-items-start text-left"><strong>Result Details:</strong></div>
                        <div id="test-result-details" class="col align-items-start text-left"></div>
                    </div>
                    <div class="row">
                        <div class="col align-items-start text-left"><strong>Test Response Filter:</strong></div>
                        <div id="test-response-filter" class="col align-items-start text-left"></div>
                    </div>
                </div>
                <div class=" col align-items-start my-2">
                    <div class="row">
                        <div class="col align-items-start text-left"><strong>Data Leak:</strong></div>
                        <div id="test-data-leak" class="col align-items-start text-left">No Data Leak Found</div>
                    </div>
                </div>
            </div>
            <!-- End of Test Details -->
        </div>

        <div class="row align-items-start">
            <div class="col fs-6">
                Endpoints Requests
            </div>
        </div>
    </div>

    <!-- External import scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/xml-formatter@3.6.0/dist/browser/xml-formatter-singleton.min.js"></script>

    <script>
        function changeTheme() {
            const htmlElement = document.documentElement;
            const themeToggle = document.getElementById("theme-toggle");
            const themeToggleIcon = document.getElementById("theme-toggle-icon");

            if (htmlElement.getAttribute("data-bs-theme") === "dark") {
                themeToggleIcon.setAttribute("class", "bi bi-brightness-high-fill");
                htmlElement.setAttribute("data-bs-theme", "light");
            } else {
                themeToggleIcon.setAttribute("class", "bi bi-brightness-high");
                htmlElement.setAttribute("data-bs-theme", "dark");
            }
        }

        function prettyPrintResponseBody(responseBody) {
            let formattedBody = '';

            try {
                // Try to parse as JSON
                const parsedJson = JSON.parse(responseBody);
                formattedBody = JSON.stringify(parsedJson, null, 2);
            } catch (jsonError) {
                try {
                    // Try to format as XML
                    formattedBody = xmlFormatter(responseBody);
                } catch (xmlError) {
                    // If not JSON or XML, treat as plain text
                    formattedBody = responseBody;
                }
            }

            return formattedBody;
        }

        function formatDataLeak(dataLeak) {
            if (dataLeak === undefined) {
                return "";
            }

            // Extract and format unique non-empty keys
            const uniqueKeys = Array.from(new Set(Object.keys(dataLeak).filter(key => key !== "")));

            // Join the keys into a comma-separated string
            const result = uniqueKeys.join(', ');

            return result;
        }

        // Function to build the query string from the query_params list
        function buildQueryString(query_params) {
            let queryString = "";

            query_params.forEach((param, index) => {
                // Check if the parameter is required and has a value
                if (param.required && param.value) {
                    // Use encodeURIComponent to encode parameter values
                    const encodedValue = encodeURIComponent(param.value);
                    const separator = index === 0 ? '?' : '&';

                    // Add the parameter to the query string
                    queryString += `${separator}${param.name}=${encodedValue}`;
                }
            });

            return queryString;
        }

        function updateHttpView(result) {

            // Reconstruct the HTTP request string
            const requestMethod = result.method;
            const requestHeaders = Object.entries(result.request_headers)
                .map(([header, value]) => `${header}: ${value}`)
                .join('\n');
            // Check if "kwargs" contains a "json" key and if it's an object
            let jsonBody = "";
            if (result.kwargs && typeof result.kwargs.json === 'object') {
                jsonBody = JSON.stringify(result.kwargs.json, null, 2);
            }
            // build query string
            const queryParamsString = buildQueryString(result.query_params);
            const requestPath = result.endpoint + queryParamsString;

            const httpRequest = `${requestMethod} ${requestPath} HTTP/1.1\n${requestHeaders}\n\n${jsonBody}`;


            // Reconstruct the HTTP response string
            const responseStatus = result.response_status_code;
            const responseHeaders = Object.entries(result.response_headers)
                .map(([header, value]) => `${header}: ${value}`)
                .join('\n');
            const responseBody = result.response_body;
            const httpResponse = `HTTP/1.1 ${responseStatus}\n${responseHeaders}\n\n${prettyPrintResponseBody(responseBody)}`;

            // Find the HTTP request and response div containers by their IDs
            const requestContainer = document.getElementById('request-card');
            const responseContainer = document.getElementById('response-card');

            // update request and response cards texts
            requestContainer.innerText = httpRequest;
            responseContainer.innerText = httpResponse;

            // update test data
            const testNameContainer = document.getElementById('test-name');
            const testEndpointContainer = document.getElementById('test-endpoint');
            const testResultContainer = document.getElementById('test-result');
            const testResultDetailsContainer = document.getElementById('test-result-details');
            const testResponseFilterContainer = document.getElementById('test-response-filter');
            const testDataLeakContainer = document.getElementById('test-data-leak');

            const dataLeaked = formatDataLeak(result.data_leak);

            testNameContainer.innerText = result.test_name;
            testEndpointContainer.innerText = `${result.method} ${result.endpoint} (${result.url})`;
            testResultContainer.innerText = result.result ? "✅ Passed" : "❌ Failed";
            testResultDetailsContainer.innerText = result.result_details;
            testResponseFilterContainer.innerText = result.response_filter;
            testDataLeakContainer.innerText = dataLeaked === "" ? "No Data Leakage Found" : dataLeaked;

        }

        const results = [{
            "test_name": "SQLi Test",
            "url": "https://petstore.swagger.io/v2/pet/78",
            "endpoint": "/pet/{petId}",
            "method": "POST",
            "body_params": [
                {
                    "type": "integer",
                    "format": "int64",
                    "value": 26,
                    "name": "id",
                    "required": true,
                    "in": "body"
                },
                {
                    "type": "integer",
                    "format": "int64",
                    "value": 57,
                    "name": "petId",
                    "required": true,
                    "in": "body"
                },
                {
                    "type": "integer",
                    "format": "int32",
                    "value": 58,
                    "name": "quantity",
                    "required": true,
                    "in": "body"
                },
                {
                    "type": "string",
                    "format": "date-time",
                    "value": "' OR 1=1 ;--",
                    "name": "shipDate",
                    "required": true,
                    "in": "body"
                },
                {
                    "type": "string",
                    "description": "Order Status",
                    "enum": [
                        "placed",
                        "approved",
                        "delivered"
                    ],
                    "value": "' OR 1=1 ;--",
                    "name": "status",
                    "required": true,
                    "in": "body"
                },
                {
                    "type": "boolean",
                    "value": "1'dj>]ZAt2",
                    "name": "complete",
                    "required": true,
                    "in": "body"
                }
            ],
            "query_params": [{
                "name": "tags",
                "in": "query",
                "description": "Tags to filter by",
                "required": true,
                "type": "array",
                "items": {
                    "type": "string"
                },
                "collectionFormat": "multi",
                "schema": null,
                "value": "{I1I.:47qT"
            }],
            "path_params": [],
            "args": [],
            "kwargs": {
                "json": {
                    "id": 26,
                    "petId": 57,
                    "quantity": 58,
                    "shipDate": "' OR 1=1 ;--",
                    "status": "' OR 1=1 ;--",
                    "complete": "1'dj>]ZAt2"
                }
            },
            "malicious_payload": "' OR 1=1 ;--",
            "result_details": "One or more parameter is vulnerable to SQL Injection Attack",
            "success_codes": [
                500
            ],
            "response_filter": "STATUS_CODE_FILTER",
            "request_headers": {
                "Host": "petstore.swagger.io",
                "Accept": "*/*",
                "Accept-Encoding": "gzip, deflate",
                "User-Agent": "Python/3.11 aiohttp/3.8.6",
                "Content-Length": "119",
                "Content-Type": "application/json"
            },
            "response_headers": {
                "Date": "Sat, 04 Nov 2023 12:08:38 GMT",
                "Content-Type": "application/json",
                "Transfer-Encoding": "chunked",
                "Connection": "keep-alive",
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow-Methods": "GET, POST, DELETE, PUT",
                "Access-Control-Allow-Headers": "Content-Type, api_key, Authorization",
                "Server": "Jetty(9.2.9.v20150224)"
            },
            "response_body": "{\"code\":500,\"type\":\"unknown\",\"message\":\"something bad happened\"}",
            //"response_body": "<\?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?><apiResponse><type>unknown</type></apiResponse>",
            "response_status_code": 500,
            "redirection": "()",
            "result": false,
            "data_leak": {
                "PhoneNumberIN": [
                    [
                        "169909971806",
                        "",
                        "",
                        "",
                        "",
                        "",
                        "169909971806",
                        "169909971806",
                        "",
                        ""
                    ]
                ], "ato": ["password"]
            }
        }]

        updateHttpView(results[0]);
    </script>
</body>

</html>